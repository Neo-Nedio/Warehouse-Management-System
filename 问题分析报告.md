# 前端无法访问后端问题分析报告

## 🔍 问题现象

- ✅ **日志接口可以访问** (`/log/**`)
- ❌ **用户接口无法访问** (`/user/**`)
- ❌ **商品接口无法访问** (`/goods/**`)
- ❌ **仓库接口无法访问** (`/warehouse/admin/**`)

## 🐛 发现的问题

### 问题1：CORS配置不完整 ⚠️ **主要问题**

**位置**：`edmo/src/main/groovy/com/example/edmo/config/WebConfig.java` 第27-31行

**当前配置**：
```java
registry.addMapping("/**")
    .allowedOrigins("http://localhost:3000")
    .allowedMethods("GET", "POST", "PUT", "DELETE");
```

**问题**：
- ❌ **缺少 `allowedHeaders`** - 没有允许自定义header（如"token"）
- ❌ **缺少 `allowCredentials`** - 没有允许携带凭证
- ❌ **缺少 `exposedHeaders`** - 没有暴露响应头

**影响**：
- 浏览器会阻止带有自定义header（"token"）的请求
- 导致所有需要token的接口请求失败
- 这是导致其他接口无法访问的主要原因

### 问题2：拦截器链依赖问题

**位置**：`edmo/src/main/groovy/com/example/edmo/config/WebConfig.java` 第36-66行

**拦截器执行顺序**：
1. `FirstInterceptor` - 拦截所有路径（除了登录相关），验证token
2. `UserPermissionInterceptor` - 拦截 `/user/**`，检查权限
3. `AdminInterceptor` - 拦截 `/warehouse/admin/**` 和 `/log/**`，检查管理员权限
4. `goodsInterceptor` - 拦截 `/goods/**`，检查权限

**问题**：
- `FirstInterceptor` 如果token为null或验证失败，会抛出异常
- 其他拦截器依赖 `UserContext.getCurrentUser()`，这需要 `FirstInterceptor` 先设置
- 如果 `FirstInterceptor` 失败，后续拦截器无法获取用户信息

### 问题3：为什么日志接口可以访问？

**可能原因**：
1. **CORS预检请求**：浏览器发送OPTIONS请求时，可能没有携带token，但CORS配置允许了OPTIONS请求通过
2. **GET请求**：某些日志接口是GET请求，可能在某些情况下通过了
3. **拦截器顺序**：`AdminInterceptor` 在 `FirstInterceptor` 之后执行，如果token验证失败，可能在某些情况下仍能访问

## 📋 问题总结

### 主要问题（必须修复）

1. **CORS配置缺少 `allowedHeaders`**
   - 前端发送的 `token` header被浏览器阻止
   - 需要添加：`.allowedHeaders("*")` 或 `.allowedHeaders("token", "Content-Type")`

2. **CORS配置缺少 `allowCredentials`**
   - 如果需要携带凭证，需要添加：`.allowCredentials(true)`

3. **CORS配置缺少OPTIONS方法支持**
   - 浏览器预检请求使用OPTIONS方法
   - 需要添加：`.allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")`

### 次要问题（建议修复）

1. **拦截器异常处理**
   - `FirstInterceptor` 抛出异常时，可能影响CORS响应
   - 建议在拦截器中处理OPTIONS请求

2. **Token验证逻辑**
   - 如果token为null，直接抛出异常可能导致CORS预检失败
   - 建议对OPTIONS请求特殊处理

## 🔧 需要修复的地方

### 1. WebConfig.java - CORS配置（最重要）

需要添加：
- `allowedHeaders("*")` 或 `allowedHeaders("token", "Content-Type", ...)`
- `allowCredentials(true)` （如果需要）
- `allowedMethods` 中添加 `"OPTIONS"`

### 2. FirstInterceptor.java - OPTIONS请求处理

建议添加对OPTIONS请求的特殊处理，避免拦截器影响CORS预检请求。

## 📝 验证方法

修复后，可以在浏览器开发者工具的Network标签中检查：
1. 请求是否发送了 `token` header
2. 响应头是否包含 `Access-Control-Allow-Headers: token`
3. OPTIONS预检请求是否成功（状态码200）






